#!/bin/sh

GREP_OPTIONS=''

cookiejar=$(mktemp cookies.XXXXXXXXXX)
netrc=$(mktemp netrc.XXXXXXXXXX)
chmod 0600 "$cookiejar" "$netrc"
function finish {
  rm -rf "$cookiejar" "$netrc"
}
trap finish EXIT
WGETRC="$wgetrc"

prompt_credentials() {
    echo "Enter your Earthdata Login credentials"
    read -p "Username (<%= @user %>): " username
    username=${username:-<%= @user %>}
    read -s -p "Password: " password
    echo "\nmachine urs.earthdata.nasa.gov\n\tlogin $username\n\tpassword $password" >> $netrc
    cat $netrc
    echo
}

exit_bad_login() {
    echo
    echo "Unable to log in"
    echo
    echo "Please ensure that you have entered your username and password correctly and"
    echo "that you have authorized the remote application by visiting the link below"
    echo "logging in:"
    echo
    echo "<%=raw @urls.first %>"
    exit 1
}

prompt_credentials

<% if @urls.first.start_with? 'https://datapool.asf.alaska.edu' %>
<%= render partial: 'asf_download' %>
<% else %>
<%= render partial: 'generic_download' %>
<% end %>

fetch_urls() {
    if command -v curl >/dev/null 2>&1; then
        detect_user_approval
        setup_auth_curl
        while read -r line; do
            curl -b "$cookie_jar" -c "$cookie_jar" -L -n -Og -- $line
        done;
    elif command -v wget >/dev/null 2>&1; then
        setup_auth_wget
        while read -r line; do
        wget --load-cookies "$cookie_jar" --save-cookies "$cookie_jar" --keep-session-cookies -- $line
        done;
    else
        fail_with_error "Error: Could not find a command-line downloader.  Please install curl or wget"
    fi
}

fetch_urls <<'EDSCEOF'
<% @urls.each do |url| %><%=raw url%>
<% end %>EDSCEOF
