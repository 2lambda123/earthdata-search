<%# This code is dead weight outside of test mode and is potentially dangerous %>
<% if Rails.env.test? %>
window.edsc.util.xhr = do (window, $=jQuery) ->
  timeoutPool = []
  realSetTimeout = window.setTimeout
  realClearTimeout = window.clearTimeout

  window.setTimeout = (f, args...) ->
    id = null
    onTimeout = ->
      try
        if typeof f == "string"
          eval(f)
        else
          f()
      finally
        index = timeoutPool.indexOf(id)
        timeoutPool.splice(id, 1) if index > -1

    id = realSetTimeout(onTimeout, args...)

  window.clearTimeout = (id) ->
    index = timeoutPool.indexOf(id)
    timeoutPool.splice(index, 1) if index > -1
    realClearTimeout(id)
    return

  xhrPool = []
  $.ajaxSetup
    beforeSend: (xhr) ->
      xhrPool.push(xhr)
    complete: (xhr) ->
      index = xhrPool.indexOf(xhr)
      xhrPool.splice(index, 1) if (index > -1)


  hasPending = ->
    xhrPool.length > 0 || timeoutPool.length > 0

  exports =
    hasPending: hasPending
<% end %>